<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/>
    <title>تحويل جداول Word إلى JSON</title>
    <script src="purify.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        h1, h2 {
            color: #1a73e8;
        }
        .btn {
            background: #1a73e8;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            margin: 8px 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #1557b0;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #b02a37;
        }
        input[type="file"], input[type="number"] {
            margin: 10px 0;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 60px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background: #e8f0fe;
            color: #1a73e8;
        }
        .section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        #outputArea .card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .card textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            min-height: 50px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .flex {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .option-box {
            flex: 1 1 45%;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .option-box.correct {
            border: 2px solid #28a745;
            background: #e6f4ea;
        }
        .option-box img, .card img {
            max-width: 100%;
            max-height: 100px;
            display: block;
            margin-top: 5px;
            border-radius: 4px;
        }
        .config-input {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .config-input label {
            font-weight: bold;
        }
        .note {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .coords-section {
            margin-bottom: 30px;
        }
        .coords-section h3 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>📝 تحويل جداول Word إلى JSON</h1>
    <p>🚀 استخراج أسئلة الكويز بسهولة وسرعة</p>

    <div class="section">
        <h2>📂 رفع ملف Word</h2>
        <input type="file" id="docxFile" accept=".docx">
    </div>

    <div class="section">
        <h2>⚙️ إعدادات الجدول</h2>
        <div class="config-input">
            <label>عدد الصفوف لكل سؤال:</label>
            <input type="number" id="rowsPerQuestion" value="5" min="1">
        </div>

        <div class="coords-section">
            <h3>🧭 إحداثيات النص القرائي والسؤال</h3>
            <p class="note">ℹ️ يمكن تحديد خلايا مختلفة أو نفس الخلية للنص وصورته (مثل نص وصورة في الصف 1، العمود 1).</p>
            <table>
                <thead>
                    <tr>
                        <th>📘 نص قرائي</th>
                        <th>🖼️ صورة النص</th>
                        <th>❓ سؤال</th>
                        <th>🖼️ صورة السؤال</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="r_reading" placeholder="صف" min="1"><input type="number" name="c_reading" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_reading_img" placeholder="صف" min="1"><input type="number" name="c_reading_img" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_question" placeholder="صف" min="1"><input type="number" name="c_question" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_question_img" placeholder="صف" min="1"><input type="number" name="c_question_img" placeholder="عمود" min="1"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="coords-section">
            <h3>🟦 إحداثيات الخيارات</h3>
            <p class="note">ℹ️ يمكن تحديد خلايا مختلفة أو نفس الخلية لنص الخيار وصورته (مثل نص وصورة في الصف 3، العمود 1).</p>
            <table>
                <thead>
                    <tr>
                        <th>① نص الخيار 1</th>
                        <th>🖼️ صورة الخيار 1</th>
                        <th>② نص الخيار 2</th>
                        <th>🖼️ صورة الخيار 2</th>
                        <th>③ نص الخيار 3</th>
                        <th>🖼️ صورة الخيار 3</th>
                        <th>④ نص الخيار 4</th>
                        <th>🖼️ صورة الخيار 4</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="r_opt1" placeholder="صف" min="1"><input type="number" name="c_opt1" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt1_img" placeholder="صف" min="1"><input type="number" name="c_opt1_img" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt2" placeholder="صف" min="1"><input type="number" name="c_opt2" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt2_img" placeholder="صف" min="1"><input type="number" name="c_opt2_img" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt3" placeholder="صف" min="1"><input type="number" name="c_opt3" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt3_img" placeholder="صف" min="1"><input type="number" name="c_opt3_img" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt4" placeholder="صف" min="1"><input type="number" name="c_opt4" placeholder="عمود" min="1"></td>
                        <td><input type="number" name="r_opt4_img" placeholder="صف" min="1"><input type="number" name="c_opt4_img" placeholder="عمود" min="1"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="btn danger" onclick="questions.length = 0; renderPreview()">🗑️ حذف الأسئلة</button>
    </div>

    <div class="section">
        <h2>🔍 تحليل الجدول</h2>
        <button class="btn" onclick="processFile()">بدء التحليل</button>
    </div>

    <div class="section">
        <h2>📋 معاينة الأسئلة</h2>
        <div id="outputArea"></div>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
        <button class="btn" onclick="exportJSON()">💾 تصدير JSON</button>
    </div>

    <script src="mammoth.browser.min.js"></script>
    <script>
        const questions = [];

        /**
         * التحقق مما إذا كان الصف فارغًا.
         * @param {HTMLTableRowElement} row - الصف.
         * @returns {boolean} true إذا كان الصف فارغًا.
         */
        function isRowEmpty(row) {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).every(cell => !cell.textContent.trim() && !cell.querySelector('img'));
        }

        /**
         * حساب عدد الأعمدة المنطقية مع الأخذ في الاعتبار colspan.
         * @param {HTMLTableRowElement} row - الصف.
         * @returns {number} عدد الأعمدة المنطقية.
         */
        function getLogicalColumnCount(row) {
            let count = 0;
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const colspan = parseInt(cell.getAttribute('colspan') || 1);
                count += colspan;
            });
            return count;
        }

        /**
         * التحقق من صحة الإحداثيات بناءً على عدد الأعمدة المنطقية في الصف.
         * @param {number} r - رقم الصف (يبدأ من 1).
         * @param {number} c - رقم العمود (يبدأ من 1).
         * @param {HTMLTableRowElement[]} rows - صفوف الجدول.
         * @param {string} field - اسم الحقل.
         * @returns {boolean} true إذا كانت الإحداثيات صالحة.
         */
        function validateCoordinates(r, c, rows, field) {
            if (r < 1 || c < 1 || r > rows.length) {
                console.log(`ℹ️ إحداثيات "${field}" غير صالحة: الصف (${r}) خارج النطاق (1-${rows.length})`);
                return false;
            }
            const logicalCols = getLogicalColumnCount(rows[r - 1]);
            if (c > logicalCols) {
                console.log(`ℹ️ إحداثيات "${field}" غير صالحة: العمود (${c}) أكبر من عدد الأعمدة المنطقية (${logicalCols}) في الصف ${r}`);
                return false;
            }
            return true;
        }

        /**
         * الحصول على الخلية بناءً على الإحداثيات المنطقية مع دعم colspan.
         * @param {HTMLTableRowElement[]} rows - صفوف الجدول.
         * @param {number} r - رقم الصف (يبدأ من 1).
         * @param {number} c - رقم العمود (يبدأ من 1).
         * @returns {HTMLTableCellElement|null} الخلية أو null.
         */
        function getCell(rows, r, c) {
            const row = rows[r - 1];
            if (!row) return null;
            const cells = row.querySelectorAll('td');
            let logicalIndex = 0;
            for (let i = 0; i < cells.length; i++) {
                const colspan = parseInt(cells[i].getAttribute('colspan') || 1);
                if (c > logicalIndex && c <= logicalIndex + colspan) {
                    return cells[i];
                }
                logicalIndex += colspan;
            }
            return null;
        }

        /**
         * استخراج الإحداثيات من حقل إدخال.
         * @param {string} field - اسم الحقل (مثل r_reading).
         * @returns {number} القيمة (صف أو عمود).
         */
        function getInputValue(field) {
            return parseInt(document.querySelector(`input[name="${field}"]`)?.value || 0);
        }

        /**
         * استخراج إحداثيات النموذج.
         * @returns {Object} كائن يحتوي على الإحداثيات.
         */
        function getCoordinates() {
            return {
                readingText: [getInputValue('r_reading'), getInputValue('c_reading')],
                readingImage: [getInputValue('r_reading_img'), getInputValue('c_reading_img')],
                questionText: [getInputValue('r_question'), getInputValue('c_question')],
                questionImage: [getInputValue('r_question_img'), getInputValue('c_question_img')],
                options: [
                    {
                        text: [getInputValue('r_opt1'), getInputValue('c_opt1')],
                        image: [getInputValue('r_opt1_img'), getInputValue('c_opt1_img')]
                    },
                    {
                        text: [getInputValue('r_opt2'), getInputValue('c_opt2')],
                        image: [getInputValue('r_opt2_img'), getInputValue('c_opt2_img')]
                    },
                    {
                        text: [getInputValue('r_opt3'), getInputValue('c_opt3')],
                        image: [getInputValue('r_opt3_img'), getInputValue('c_opt3_img')]
                    },
                    {
                        text: [getInputValue('r_opt4'), getInputValue('c_opt4')],
                        image: [getInputValue('r_opt4_img'), getInputValue('c_opt4_img')]
                    }
                ]
            };
        }

        /**
         * استخراج النص النقي من الخلية.
         * @param {HTMLElement} cell - الخلية.
         * @returns {string} النص النقي.
         */
        function extractPureText(cell) {
            const text = cell.textContent ? cell.textContent.trim().replace(/\s+/g, ' ') : '';
            return text || '';
        }

        /**
         * استخراج محتوى الخلية.
         * @param {HTMLTableRowElement[]} rows - صفوف الجدول.
         * @param {number[]} coord - [صف, عمود].
         * @param {number} offset - إزاحة الصف.
         * @param {string} field - اسم الحقل.
         * @returns {Object} { text, image }.
         */
        function extractCell(rows, [r, c], offset = 0, field) {
            const cell = getCell(rows, r + offset, c);
            if (!cell) {
                console.log(`ℹ️ الخلية (${r + offset}, ${c}) لـ "${field}" غير موجودة`);
                return { text: '', image: null };
            }
            const rawHTML = cell.innerHTML;
            const colspan = cell.getAttribute('colspan') || 1;
            const text = extractPureText(cell);
            const image = cell.querySelector('img')?.src || null;
            console.log(`📄 استخراج "${field}" من (${r + offset}, ${c}): نص="${text}", صورة=${image ? 'موجودة' : 'غير موجودة'}, colspan=${colspan}, HTML=${rawHTML.substring(0, 200) + (rawHTML.length > 200 ? '...' : '')}`);
            return { text, image };
        }

        /**
         * اكتشاف الإجابة الصحيحة بناءً على علامة النجمة.
         * @param {Object} question - كائن السؤال.
         * @param {HTMLTableRowElement[]} rows - صفوف الجدول.
         * @param {number} startRow - رقم الصف الأول.
         * @param {number} endRow - رقم الصف الأخير.
         */
        function detectCorrectAnswer(question, rows, startRow, endRow) {
            const starPattern = /[\*★✱∗]/;
            let correctCount = 0;

            question.options.forEach((opt, index) => {
                if (starPattern.test(opt.text)) {
                    question.correct = index;
                    opt.text = opt.text.replace(starPattern, '').trim();
                    correctCount++;
                }
            });

            if (question.correct === -1) {
                for (let i = startRow; i < endRow && i < rows.length; i++) {
                    const cells = rows[i].querySelectorAll('td');
                    cells.forEach((cell, cellIndex) => {
                        if (starPattern.test(extractPureText(cell))) {
                            question.correct = cellIndex % 4;
                            cell.textContent = cell.textContent.replace(starPattern, '').trim();
                            correctCount++;
                        }
                    });
                }
            }

            if (correctCount > 1) {
                console.warn(`⚠️ تم العثور على أكثر من إجابة صحيحة في السؤال`);
            }
        }

        /**
         * استخراج سؤال من جزء من الجدول.
         * @param {HTMLTableRowElement[]} rows - صفوف الجدول.
         * @param {Object} coords - إحداثيات النموذج.
         * @param {number} startRow - رقم الصف الأول.
         * @param {number} rowsPerQuestion - عدد الصفوف لكل سؤال.
         * @returns {Object|null} كائن السؤال أو null.
         */
        function extractQuestion(rows, coords, startRow, rowsPerQuestion) {
            if (!rows?.length || startRow >= rows.length) {
                return null;
            }

            const questionRows = rows.slice(startRow, startRow + rowsPerQuestion);
            if (!questionRows.length) {
                return null;
            }

            const maxRows = questionRows.length;
            const maxCols = Math.max(...questionRows.map(row => getLogicalColumnCount(row)));
            console.log(`📏 أبعاد السؤال (من الصف ${startRow + 1}): ${maxRows} صفوف، بحد أقصى ${maxCols} أعمدة`);

            const fields = [
                { coord: coords.readingText, name: 'نص قرائي' },
                { coord: coords.readingImage, name: 'صورة النص' },
                { coord: coords.questionText, name: 'نص السؤال' },
                { coord: coords.questionImage, name: 'صورة السؤال' },
                ...coords.options.map((opt, i) => [
                    { coord: opt.text, name: `نص الخيار ${i + 1}` },
                    { coord: opt.image, name: `صورة الخيار ${i + 1}` }
                ]).flat()
            ];

            fields.forEach(({ coord, name }) => {
                const [r, c] = coord;
                if (r !== 0 && c !== 0 && !validateCoordinates(r, c, questionRows, name)) {
                    console.log(`ℹ️ إحداثيات "${name}" غير صالحة: (${r}, ${c})`);
                }
            });

            const question = {
                reading: {
                    text: extractCell(rows, coords.readingText, startRow, 'نص قرائي').text,
                    image: extractCell(rows, coords.readingImage, startRow, 'صورة النص').image
                },
                question: {
                    text: extractCell(rows, coords.questionText, startRow, 'نص السؤال').text,
                    image: extractCell(rows, coords.questionImage, startRow, 'صورة السؤال').image
                },
                options: coords.options.map((opt, i) => ({
                    text: extractCell(rows, opt.text, startRow, `نص الخيار ${i + 1}`).text,
                    image: extractCell(rows, opt.image, startRow, `صورة الخيار ${i + 1}`).image
                })),
                correct: -1
            };

            detectCorrectAnswer(question, rows, startRow, startRow + rowsPerQuestion);

            return (question.reading.text || question.reading.image ||
                    question.question.text || question.question.image ||
                    question.options.some(opt => opt.text || opt.image)) ? question : null;
        }

        /**
         * معالجة رفع الصور.
         * @param {Event} event - حدث إدخال الملف.
         * @param {number} qIndex - رقم السؤال.
         * @param {string} field - اسم الحقل.
         */
        function uploadImage(event, qIndex, field) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result;
                if (field === 'reading' || field === 'question') {
                    questions[qIndex][field].image = base64;
                } else if (field.startsWith('option')) {
                    const optionIndex = parseInt(field.split('-')[1]);
                    questions[qIndex].options[optionIndex].image = base64;
                }
                renderPreview();
            };
            reader.readAsDataURL(file);
        }

        /**
         * معالجة ملف Word.
         */
        async function processFile() {
            const fileInput = document.getElementById('docxFile');
            const file = fileInput.files[0];
            const rowsPerQuestion = parseInt(document.getElementById('rowsPerQuestion').value) || 5;

            if (!file) {
                alert("🚨 الرجاء اختيار ملف Word!");
                return;
            }

            if (!file.name.endsWith('.docx')) {
                alert("🚨 يرجى اختيار ملف بصيغة .docx");
                return;
            }

            try {
                const buffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer: buffer });
                console.log(`📜 HTML الناتج: ${result.value.substring(0, 500) + (result.value.length > 500 ? '...' : '')}`);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = DOMPurify.sanitize(result.value);
                const tables = tempDiv.querySelectorAll('table');
                const coords = getCoordinates();

                questions.length = 0;

                if (!tables.length) {
                    alert("⚠️ لم يتم العثور على جداول في الملف!");
                    return;
                }

                tables.forEach((table, tableIndex) => {
                    const rows = Array.from(table.querySelectorAll('tr'));
                    let currentRow = 0;

                    while (currentRow < rows.length) {
                        while (currentRow < rows.length && isRowEmpty(rows[currentRow])) {
                            currentRow++;
                        }

                        if (currentRow >= rows.length) break;

                        const question = extractQuestion(rows, coords, currentRow, rowsPerQuestion);
                        if (question) {
                            questions.push(question);
                        }

                        currentRow += rowsPerQuestion;
                    }
                });

                renderPreview();

                if (questions.length === 0) {
                    alert("⚠️ لم يتم استخراج أي أسئلة!");
                }
            } catch (err) {
                alert(`🚨 خطأ في معالجة الملف: ${err.message}`);
                console.error(err);
            }
        }

        /**
         * عرض معاينة الأسئلة.
         */
        function renderPreview() {
            const container = document.getElementById('outputArea');
            container.innerHTML = '';

            if (!questions.length) {
                container.innerHTML = DOMPurify.sanitize('<p>🚫 لا توجد أسئلة مستخرجة.</p>');
                return;
            }

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = DOMPurify.sanitize(`
                    <h3>🧠 سؤال ${index + 1}</h3>
                    <div><strong>📘 النص القرائي:</strong>
                        <textarea onchange="questions[${index}].reading.text=this.value">${q.reading.text}</textarea>
                        ${q.reading.image ? `<img src="${q.reading.image}">` : ''}
                        <input type="file" accept="image/*" onchange="uploadImage(event, ${index}, 'reading')">
                    </div>
                    <div><strong>❓ السؤال:</strong>
                        <textarea onchange="questions[${index}].question.text=this.value">${q.question.text}</textarea>
                        ${q.question.image ? `<img src="${q.question.image}">` : ''}
                        <input type="file" accept="image/*" onchange="uploadImage(event, ${index}, 'question')">
                    </div>
                    <div><strong>🟦 الخيارات:</strong>
                        <div class="flex">
                            ${q.options.map((opt, i) => `
                                <div class="option-box ${q.correct === i ? 'correct' : ''}">
                                    <label>خيار ${i + 1}</label><br>
                                    <textarea onchange="questions[${index}].options[${i}].text=this.value">${opt.text}</textarea>
                                    ${opt.image ? `<img src="${opt.image}">` : ''}
                                    <input type="file" accept="image/*" onchange="uploadImage(event, ${index}, 'option-${i}')">
                                    <button class="btn" onclick="questions[${index}].correct=${i}; renderPreview()">✅ إجابة صحيحة</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="btn danger" onclick="questions.splice(${index},1); renderPreview()">🗑️ حذف السؤال</button>
                `);
                container.appendChild(card);
            });
        }

        /**
         * تصدير الأسئلة كـ JSON.
         */
        function exportJSON() {
            if (!questions.length) {
                alert("⚠️ لا يوجد محتوى لتصديره!");
                return;
            }

            const json = JSON.stringify(questions, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quiz.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
